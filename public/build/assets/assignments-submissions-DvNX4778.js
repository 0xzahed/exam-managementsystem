document.addEventListener("DOMContentLoaded",function(){b(),w(),k(),S()});function b(){const e=document.getElementById("searchSubmissions");e&&e.addEventListener("input",function(n){const t=n.target.value.toLowerCase();y(t)})}function w(){const e=document.getElementById("filterSubmissions");e&&e.addEventListener("change",function(n){const t=n.target.value;h(t)})}function y(e){document.querySelectorAll(".submission-row").forEach(t=>{const s=t.getAttribute("data-student-name").toLowerCase(),a=t.querySelector(".text-gray-500").textContent.toLowerCase();s.includes(e)||a.includes(e)?t.style.display="":t.style.display="none"})}function h(e){document.querySelectorAll(".submission-row").forEach(t=>{const s=t.cells[3],a=t.cells[2],o=!s.querySelector(".bg-yellow-100"),i=a.querySelector(".bg-red-100");let d=!1;switch(e){case"all":d=!0;break;case"graded":d=o;break;case"pending":d=!o;break;case"late":d=!!i;break}t.style.display=d?"":"none"})}function k(){document.addEventListener("click",function(e){e.target.classList.contains("bg-black")&&f()}),document.addEventListener("keydown",function(e){e.key==="Escape"&&f()})}function S(){const e=document.getElementById("gradeForm");e&&e.addEventListener("submit",v);const n=document.getElementById("updateMarksForm");n&&n.addEventListener("submit",C)}function E(e){showInfo("Loading submission details..."),window.location.href=`/instructor/assignments/submissions/${e}/view`}let c=null;function I(e){c=e;const n=document.getElementById("gradeForm");n.action=`/instructor/assignments/submissions/${e}/grade`;const t=document.getElementById("submissionIdInput");t&&(t.value=e);const s=document.querySelector(`[onclick*="${e}"]`).closest("tr"),o=s.cells[3].querySelector(".text-gray-900"),i=s.querySelector("[data-feedback]"),d=document.getElementById("gradeInput"),r=document.getElementById("feedbackInput");if(o){const p=o.textContent.trim().split("/")[0];d.value=p}else d.value="";i?r.value=i.getAttribute("data-feedback")||"":r.value="";const g=document.getElementById("gradeModal");g.classList.remove("hidden"),g.classList.add("flex"),d.focus()}function u(){const e=document.getElementById("gradeModal");e.classList.add("hidden"),e.classList.remove("flex"),c=null}function v(e){if(e.preventDefault(),!c)return;const n=document.getElementById("gradeInput"),t=document.getElementById("feedbackInput"),s=parseInt(n.getAttribute("max")),a=parseFloat(n.value),o=t.value.trim();if(isNaN(a)||a<0||a>s){showErrorToast(`Grade must be between 0 and ${s}`);return}const i=e.target.querySelector('button[type="submit"]'),d=i.innerHTML;i.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Saving...',i.disabled=!0,fetch(`/instructor/assignments/submissions/${c}/grade`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({grade:a,feedback:o})}).then(r=>{if(r.redirected){window.location.href=r.url;return}return r.json()}).then(r=>{r&&r.success?(showSuccess("Grade saved successfully!"),L(c,a,s,o),u(),F()):r&&showError(r.message||"Failed to save grade")}).catch(r=>{console.error("Error:",r),M(c,a,o)}).finally(()=>{i.innerHTML=d,i.disabled=!1})}function M(e,n,t){const s=document.createElement("form");s.method="POST",s.action=`/instructor/assignments/submissions/${e}/grade`;const a=document.createElement("input");a.type="hidden",a.name="_token",a.value=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),s.appendChild(a);const o=document.createElement("input");o.type="hidden",o.name="grade",o.value=n,s.appendChild(o);const i=document.createElement("input");i.type="hidden",i.name="feedback",i.value=t,s.appendChild(i),document.body.appendChild(s),s.submit()}function L(e,n,t,s){const a=document.querySelector(`[onclick*="gradeSubmission(${e})"]`).closest("tr"),o=a.cells[3],i=(n/t*100).toFixed(1);o.innerHTML=`
        <div class="text-sm font-medium text-gray-900">${n}/${t}</div>
        <div class="text-sm text-gray-500">${i}%</div>
    `;const d=a.querySelector('[onclick*="gradeSubmission"]');d.className=d.className.replace("bg-blue-100 text-blue-800 hover:bg-blue-200","bg-green-100 text-green-800 hover:bg-green-200"),d.innerHTML='<i class="fas fa-edit mr-1"></i>Edit Grade',s&&a.setAttribute("data-feedback",s)}function T(e){showLoadingToast("Preparing download...");const n=`/instructor/assignments/submissions/${e}/download`,t=document.createElement("a");t.href=n,t.download="",document.body.appendChild(t),t.click(),document.body.removeChild(t),showSuccessToast("Download started")}function x(){const e=document.getElementById("updateMarksModal"),n=document.getElementById("newMarksInput");e.classList.remove("hidden"),e.classList.add("flex"),n.focus()}function l(){const e=document.getElementById("updateMarksModal");e.classList.add("hidden"),e.classList.remove("flex")}function C(e){e.preventDefault();const n=document.getElementById("newMarksInput"),t=document.getElementById("updateOption"),s=parseFloat(n.value),a=t.value;if(isNaN(s)||s<=0||s>1e3){showErrorToast("Please enter a valid marks value between 1 and 1000");return}if(!confirm(`Are you sure you want to update the total marks to ${s}? This will affect all submissions.`))return;const o=e.target.querySelector('button[type="submit"]'),i=o.innerHTML;o.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Updating...',o.disabled=!0;const d=m();fetch(`/assignments/${d}/update-marks`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({new_marks:s,update_option:a})}).then(r=>r.json()).then(r=>{r.success?(showSuccessToast("Assignment marks updated successfully!"),l(),setTimeout(()=>window.location.reload(),1e3)):showErrorToast(r.message||"Failed to update marks")}).catch(r=>{showError("Network error occurred"),console.error("Error:",r)}).finally(()=>{o.innerHTML=i,o.disabled=!1})}function A(){const e=document.querySelectorAll(".bg-yellow-100").length;if(e===0){showInfo("No pending submissions to grade");return}const n=prompt(`Enter grade for all ${e} pending submissions:`);if(n===null)return;const t=parseFloat(n),s=parseInt(document.getElementById("gradeInput").getAttribute("max"));if(isNaN(t)||t<0||t>s){showError(`Grade must be between 0 and ${s}`);return}if(!confirm(`Are you sure you want to assign ${t} marks to all pending submissions?`))return;showInfo("Applying bulk grades...");const a=m();fetch(`/assignments/${a}/bulk-grade`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({grade:t})}).then(o=>o.json()).then(o=>{o.success?(showSuccess(`Successfully graded ${o.count} submissions!`),setTimeout(()=>window.location.reload(),1e3)):showError(o.message||"Failed to apply bulk grades")}).catch(o=>{showError("Network error occurred"),console.error("Error:",o)})}function B(){showInfo("Preparing export...");const n=`/assignments/${m()}/export-submissions`,t=document.createElement("a");t.href=n,t.download="",document.body.appendChild(t),t.click(),document.body.removeChild(t),showSuccess("Export started")}function F(){setTimeout(()=>window.location.reload(),2e3)}function m(){const n=window.location.pathname.match(/\/assignments\/(\d+)/);return n?n[1]:null}function f(){u(),l()}window.viewSubmission=E;window.gradeSubmission=I;window.downloadSubmission=T;window.updateAssignmentMarks=x;window.bulkGrade=A;window.exportSubmissions=B;window.closeGradeModal=u;window.closeUpdateMarksModal=l;
